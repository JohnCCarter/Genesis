<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .log {
        width: 100%;
        height: 340px;
        border: 1px solid #ccc;
        padding: 0;
        overflow-y: auto;
        background: #fafafa;
      }
      .log-entry {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
      }
      .timestamp {
        color: #888;
        font-size: 12px;
        margin-right: 6px;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        margin-right: 6px;
        color: #fff;
      }
      .info {
        background: #4a90e2;
      }
      .success {
        background: #27ae60;
      }
      .warn {
        background: #f39c12;
      }
      .error {
        background: #e74c3c;
      }
      .title {
        font-weight: 600;
        margin-right: 6px;
      }
      pre {
        background: #f7f7f7;
        padding: 8px;
        border-radius: 4px;
        overflow: auto;
        margin: 6px 0 0;
      }
      .small {
        font-size: 12px;
        color: #555;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      button {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>TradingBot WebSocket Test</h1>

    <div>
      <button id="getTokenBtn">1. Hämta Token</button>
      <button id="connectBtn" disabled>2. Anslut WebSocket</button>
      <button id="disconnectBtn" disabled>3. Koppla från</button>
    </div>

    <div style="margin-top: 20px">
      <h3>Token:</h3>
      <textarea id="tokenArea" style="width: 100%; height: 80px"></textarea>
    </div>

    <div style="margin-top: 20px">
      <h3>Snabbtester (REST med JWT)</h3>
      <div
        style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end"
      >
        <div>
          <label>Symbol</label><br />
          <input id="symbolInput" value="tTESTBTC:TESTUSD" />
          <button id="loadSymbolsBtn" disabled>Hämta symboler</button>
          <select id="symbolsSelect" disabled></select>
        </div>
        <div>
          <label>Amount</label><br />
          <input id="amountInput" value="0.001" />
        </div>
        <div>
          <label>Pris (för LIMIT)</label><br />
          <input id="priceInput" value="10000" />
        </div>
        <div>
          <label>Ordertyp</label><br />
          <select id="typeSelect">
            <option>EXCHANGE MARKET</option>
            <option selected>EXCHANGE LIMIT</option>
          </select>
        </div>
        <div>
          <label>Side</label><br />
          <select id="sideSelect">
            <option selected>buy</option>
            <option>sell</option>
          </select>
        </div>
        <button id="placeOrderBtn" disabled>Placera order</button>
        <button id="cancelAllBtn" disabled>Avbryt alla</button>
        <button id="getWalletsBtn" disabled>Hämta wallets</button>
        <button id="getPositionsBtn" disabled>Hämta positions</button>
        <button id="getTickerBtn" disabled>Hämta ticker</button>
        <button id="getCandlesBtn" disabled>Hämta candles</button>
        <button id="watchlistBtn" disabled>Watchlist</button>
        <button id="perfBtn" disabled>Performance</button>
        <button id="perfDetailBtn" disabled>Perf detail</button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Bracket-order (entry + SL/TP)</h3>
      <div class="row">
        <div>
          <label>Symbol</label><br />
          <input id="brSymbol" value="tTESTBTC:TESTUSD" style="width: 150px" />
        </div>
        <div>
          <label>Amount</label><br />
          <input id="brAmount" value="0.001" style="width: 100px" />
        </div>
        <div>
          <label>Side</label><br />
          <select id="brSide">
            <option selected>buy</option>
            <option>sell</option>
          </select>
        </div>
        <div>
          <label>Entry typ</label><br />
          <select id="brType">
            <option selected>EXCHANGE MARKET</option>
            <option>EXCHANGE LIMIT</option>
          </select>
        </div>
        <div>
          <label>Entry pris (vid LIMIT)</label><br />
          <input id="brEntryPrice" value="10000" style="width: 120px" />
        </div>
        <div>
          <label>SL pris</label><br />
          <input id="brSl" value="9500" style="width: 120px" />
        </div>
        <div>
          <label>TP pris</label><br />
          <input id="brTp" value="10500" style="width: 120px" />
        </div>
        <button id="placeBracketBtn" disabled>Placera bracket</button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Order Templates</h3>
      <div class="row">
        <div>
          <label>Namn</label><br />
          <input id="tplName" placeholder="Min mall" style="width: 180px" />
        </div>
        <button id="saveTplBtn" disabled>Spara mall (från Bracket)</button>
        <button id="listTplBtn" disabled>Visa mallar</button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Backtest</h3>
      <div class="row">
        <div>
          <label>Symbol</label><br />
          <input id="btSymbol" value="tTESTBTC:TESTUSD" style="width: 150px" />
        </div>
        <div>
          <label>TF</label><br />
          <input id="btTf" value="1m" style="width: 80px" />
        </div>
        <div>
          <label>Limit</label><br />
          <input id="btLimit" type="number" value="500" style="width: 90px" />
        </div>
        <button id="runBtBtn" disabled>Kör backtest</button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Positionsstorlek & Hälsa</h3>
      <div
        style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end"
      >
        <label>Risk %</label>
        <input
          id="riskPercent"
          type="number"
          value="1"
          min="0"
          max="100"
          step="0.1"
          style="width: 90px"
        />
        <label>Symbol</label>
        <input id="sizeSymbol" value="tBTCUSD" style="width: 120px" />
        <label>Side</label>
        <select id="sizeSide">
          <option>buy</option>
          <option>sell</option>
        </select>
        <label>TF</label>
        <input id="sizeTf" value="1m" style="width: 60px" />
        <label>SL x ATR</label>
        <input
          id="slAtr"
          type="number"
          value="1.5"
          step="0.1"
          style="width: 70px"
        />
        <label>TP x ATR</label>
        <input
          id="tpAtr"
          type="number"
          value="3"
          step="0.1"
          style="width: 70px"
        />
        <button id="calcSizeBtn" disabled>Beräkna storlek</button>
        <button id="healthBtn" disabled>Health</button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Strategiinställningar (vikter)</h3>
      <div
        style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end"
      >
        <input
          id="emaWeight"
          type="number"
          step="0.05"
          min="0"
          max="1"
          placeholder="EMA weight"
          style="width: 110px"
        />
        <input
          id="rsiWeight"
          type="number"
          step="0.05"
          min="0"
          max="1"
          placeholder="RSI weight"
          style="width: 110px"
        />
        <input
          id="atrWeight"
          type="number"
          step="0.05"
          min="0"
          max="1"
          placeholder="ATR weight"
          style="width: 110px"
        />
        <button id="getStrategySettingsBtn" disabled>
          Hämta inställningar
        </button>
        <button id="saveStrategySettingsBtn" disabled>
          Spara inställningar
        </button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Risk & Handelsfönster</h3>
      <div
        style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end"
      >
        <button id="riskStatusBtn" disabled>Hämta riskstatus</button>
        <label>Max trades/dag</label>
        <input
          id="maxTradesInput"
          type="number"
          value="10"
          style="width: 90px"
        />
        <button id="updateMaxTradesBtn" disabled>Uppdatera max trades</button>
        <label>Pausa</label>
        <select id="pauseSelect">
          <option value="false">false</option>
          <option value="true">true</option>
        </select>
        <button id="updatePauseBtn" disabled>Uppdatera paus</button>
      </div>
      <div style="margin-top: 10px">
        <label>Timezone</label>
        <input id="tzInput" value="Europe/Stockholm" />
        <label style="margin-left: 10px">Mån-fre</label>
        <input id="winMon" value="08:00-17:00" />
        <input id="winTue" value="08:00-17:00" />
        <input id="winWed" value="08:00-17:00" />
        <input id="winThu" value="08:00-17:00" />
        <input id="winFri" value="08:00-16:00" />
        <button id="updateWindowsBtn" disabled>Uppdatera fönster</button>
      </div>
    </div>

    <div style="margin-top: 20px">
      <h3>Log:</h3>
      <div class="toolbar">
        <button id="clearLogBtn">Rensa logg</button>
        <span class="small"
          >Tips: Klicka på händelser för att expandera JSON-detaljer.</span
        >
      </div>
      <div id="logArea" class="log"></div>
    </div>

    <script>
      let socket = null;
      let token = null;

      function pretty(obj) {
        try {
          return JSON.stringify(obj, null, 2);
        } catch {
          return String(obj);
        }
      }
      function logHtml(html) {
        const wrap = document.createElement("div");
        wrap.className = "log-entry";
        wrap.innerHTML = html;
        const logArea = document.getElementById("logArea");
        logArea.appendChild(wrap);
        logArea.scrollTop = logArea.scrollHeight;
      }
      function log(message, type = "info") {
        const ts = new Date().toLocaleTimeString();
        if (typeof message === "object") {
          logHtml(
            `<span class="timestamp">[${ts}]</span><span class="badge ${type}">${type.toUpperCase()}</span><pre>${pretty(
              message
            )}</pre>`
          );
        } else {
          logHtml(
            `<span class="timestamp">[${ts}]</span><span class="badge ${type}">${type.toUpperCase()}</span><span>${message}</span>`
          );
        }
      }
      function logSection(title, data, type = "info") {
        const ts = new Date().toLocaleTimeString();
        const content =
          typeof data === "string" ? data : `<pre>${pretty(data)}</pre>`;
        logHtml(
          `<span class="timestamp">[${ts}]</span><span class="badge ${type}">${type.toUpperCase()}</span><span class="title">${title}</span>${content}`
        );
      }
      document.getElementById("clearLogBtn").addEventListener("click", () => {
        document.getElementById("logArea").innerHTML = "";
      });

      document
        .getElementById("getTokenBtn")
        .addEventListener("click", async () => {
          log("Requesting token...");
          try {
            // Försök med testservern först (port 8080)
            try {
              log("Trying test server on port 8080...");
              const response = await fetch(
                "http://localhost:8080/api/v2/auth/ws-token-test"
              );
              const data = await response.json();
              if (data.success && data.token) {
                token = data.token;
                document.getElementById("tokenArea").value = token;
                document.getElementById("connectBtn").disabled = false;
                log("Token received from test server successfully.");
                return;
              }
            } catch (e) {
              log("Test server not available, trying main server...");
            }

            // Fallback till huvudservern (port 8000)
            const response = await fetch(
              "http://localhost:8000/api/v2/auth/ws-token",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  user_id: "test_user",
                  scope: "read",
                  expiry_hours: 1,
                }),
              }
            );

            const data = await response.json();
            if (data.success && data.token) {
              token = data.token;
              document.getElementById("tokenArea").value = token;
              document.getElementById("connectBtn").disabled = false;
              log("Token received from main server successfully.");
            } else {
              log("Failed to get token: " + (data.error || "Unknown error"));
            }
          } catch (error) {
            log("Error getting token: " + error.message);
          }
        });

      document.getElementById("connectBtn").addEventListener("click", () => {
        if (!token) {
          log("No token available. Get a token first.");
          return;
        }

        try {
          log("Connecting to WebSocket...");

          // Anslut till Socket.IO med token via query (webbläsare kan inte skicka headers)
          socket = io("http://localhost:8000", {
            path: "/ws/socket.io",
            transports: ["websocket", "polling"],
            query: { token },
            reconnectionAttempts: 3,
            reconnectionDelay: 1000,
          });

          socket.on("connect", () => {
            log("✅ Connected to WebSocket!");
            document.getElementById("disconnectBtn").disabled = false;
            document.getElementById("connectBtn").disabled = true;
            // Aktivera REST-knappar
            document.getElementById("placeOrderBtn").disabled = false;
            document.getElementById("cancelAllBtn").disabled = false;
            document.getElementById("getWalletsBtn").disabled = false;
            document.getElementById("getPositionsBtn").disabled = false;
            document.getElementById("getTickerBtn").disabled = false;
            document.getElementById("getCandlesBtn").disabled = false;
            document.getElementById("riskStatusBtn").disabled = false;
            document.getElementById("updateMaxTradesBtn").disabled = false;
            document.getElementById("updatePauseBtn").disabled = false;
            document.getElementById("updateWindowsBtn").disabled = false;
            document.getElementById("getStrategySettingsBtn").disabled = false;
            document.getElementById("saveStrategySettingsBtn").disabled = false;
            document.getElementById("calcSizeBtn").disabled = false;
            document.getElementById("healthBtn").disabled = false;
            document.getElementById("loadSymbolsBtn").disabled = false;
            document.getElementById("symbolsSelect").disabled = false;
            document.getElementById("watchlistBtn").disabled = false;
            document.getElementById("perfBtn").disabled = false;
            document.getElementById("perfDetailBtn").disabled = false;
            document.getElementById("placeBracketBtn").disabled = false;
            document.getElementById("saveTplBtn").disabled = false;
            document.getElementById("listTplBtn").disabled = false;
            document.getElementById("runBtBtn").disabled = false;
          });

          socket.on("authenticated", (data) => {
            logSection("Authenticated", data, "success");
          });

          socket.on("connect_error", (error) => {
            logSection("Connection Error", { error: error.message }, "error");
          });

          socket.on("disconnect", (reason) => {
            logSection("Disconnected", { reason }, "warn");
            document.getElementById("disconnectBtn").disabled = true;
            document.getElementById("connectBtn").disabled = false;
          });

          // Wallet events
          socket.on("wallet_snapshot", (data) => {
            logSection("Wallet snapshot", data);
          });
          socket.on("wallet_update", (data) => {
            logSection("Wallet update", data);
          });

          // Position events
          socket.on("position_snapshot", (data) => {
            logSection("Position snapshot", data);
          });
          socket.on("position_update", (data) => {
            logSection("Position update", data);
          });
          socket.on("position_close", (data) => {
            logSection("Position close", data);
          });

          // Order events
          socket.on("order_snapshot", (data) => {
            logSection("Order snapshot", data);
          });
          socket.on("order_new", (data) => {
            logSection("Order new", data);
          });
          socket.on("order_update", (data) => {
            logSection("Order update", data);
          });
          socket.on("order_cancel", (data) => {
            logSection("Order cancel", data);
          });

          // Trade events
          socket.on("trade_executed", (data) => {
            logSection("Trade executed", data);
          });
          socket.on("trade_update", (data) => {
            logSection("Trade update", data);
          });

          // Notifications & health
          socket.on("notification", (data) => {
            const t = (data && data.type) || "info";
            const title = (data && data.title) || "Notification";
            logSection(
              title,
              data.payload || data,
              t === "error" ? "error" : t === "warn" ? "warn" : "info"
            );
          });
          socket.on("health", (data) => {
            logSection("WS Health", data);
          });
        } catch (error) {
          log("Error connecting to WebSocket: " + error.message);
        }
      });

      document.getElementById("disconnectBtn").addEventListener("click", () => {
        if (socket) {
          log("Disconnecting from WebSocket...");
          socket.disconnect();
          socket = null;
        }
      });

      // REST helpers
      async function restFetch(path, options = {}) {
        if (!token) throw new Error("Ingen token");
        const base = "http://localhost:8000";
        const headers = Object.assign(
          {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          options.headers || {}
        );
        const res = await fetch(
          `${base}${path}`,
          Object.assign({}, options, { headers })
        );
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`${res.status} ${res.statusText}: ${txt}`);
        }
        return res.json();
      }

      document
        .getElementById("placeOrderBtn")
        .addEventListener("click", async () => {
          try {
            const symbol = document.getElementById("symbolInput").value.trim();
            const amount = document.getElementById("amountInput").value.trim();
            const price = document.getElementById("priceInput").value.trim();
            const type = document.getElementById("typeSelect").value;
            const side = document.getElementById("sideSelect").value;
            const payload = { symbol, amount, type, side };
            if (!type.includes("MARKET")) {
              payload.price = price;
            }
            log(`Placing order: ${JSON.stringify(payload)}`);
            const resp = await restFetch("/api/v2/order", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            logSection("Order response", resp, "success");
          } catch (e) {
            logSection("Order error", { message: e.message }, "error");
          }
        });

      document
        .getElementById("cancelAllBtn")
        .addEventListener("click", async () => {
          try {
            const resp = await restFetch("/api/v2/orders/cancel/all", {
              method: "POST",
            });
            logSection("Cancel all", resp, "success");
          } catch (e) {
            logSection("Cancel error", { message: e.message }, "error");
          }
        });

      document
        .getElementById("getWalletsBtn")
        .addEventListener("click", async () => {
          try {
            const resp = await restFetch("/api/v2/wallets");
            logSection("Wallets", { count: (resp || []).length, data: resp });
          } catch (e) {
            logSection("Wallets error", { message: e.message }, "error");
          }
        });

      document
        .getElementById("getPositionsBtn")
        .addEventListener("click", async () => {
          try {
            const resp = await restFetch("/api/v2/positions");
            logSection("Positions", { count: (resp || []).length, data: resp });
          } catch (e) {
            logSection("Positions error", { message: e.message }, "error");
          }
        });

      // Market data
      document
        .getElementById("loadSymbolsBtn")
        .addEventListener("click", async () => {
          try {
            const arr = await restFetch(
              `/api/v2/market/symbols?test_only=true&format=v2`
            );
            const sel = document.getElementById("symbolsSelect");
            sel.innerHTML = "";
            arr.forEach((s) => {
              const opt = document.createElement("option");
              opt.value = s;
              opt.textContent = s;
              sel.appendChild(opt);
            });
            logSection("Symbols loaded", { count: arr.length });
            sel.addEventListener("change", () => {
              const v = sel.value;
              document.getElementById("symbolInput").value = v;
              document.getElementById("sizeSymbol").value = v;
            });
          } catch (e) {
            logSection("Symbols error", { message: e.message }, "error");
          }
        });
      document
        .getElementById("getTickerBtn")
        .addEventListener("click", async () => {
          try {
            const symbol =
              document.getElementById("symbolInput").value || "tBTCUSD";
            const resp = await restFetch(
              `/api/v2/market/ticker/${encodeURIComponent(symbol)}`
            );
            logSection("Ticker", resp);
          } catch (e) {
            logSection("Ticker error", { message: e.message }, "error");
          }
        });
      document
        .getElementById("getCandlesBtn")
        .addEventListener("click", async () => {
          try {
            const symbol =
              document.getElementById("symbolInput").value || "tBTCUSD";
            const resp = await restFetch(
              `/api/v2/market/candles/${encodeURIComponent(
                symbol
              )}?timeframe=1m&limit=50`
            );
            logSection("Candles + strategy", resp);
          } catch (e) {
            logSection("Candles error", { message: e.message }, "error");
          }
        });

      // Bracket-order
      document
        .getElementById("placeBracketBtn")
        .addEventListener("click", async () => {
          try {
            const symbol = (
              document.getElementById("brSymbol").value || ""
            ).trim();
            const amount = (
              document.getElementById("brAmount").value || ""
            ).trim();
            const side = document.getElementById("brSide").value;
            const entry_type = document.getElementById("brType").value;
            const entry_price = (
              document.getElementById("brEntryPrice").value || ""
            ).trim();
            const sl_price = (
              document.getElementById("brSl").value || ""
            ).trim();
            const tp_price = (
              document.getElementById("brTp").value || ""
            ).trim();
            const payload = { symbol, amount, side, entry_type };
            if (entry_type.includes("LIMIT")) payload.entry_price = entry_price;
            if (sl_price) payload.sl_price = sl_price;
            if (tp_price) payload.tp_price = tp_price;
            logSection("Bracket-order request", payload);
            const resp = await restFetch("/api/v2/order/bracket", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            logSection("Bracket-order response", resp, "success");
          } catch (e) {
            logSection("Bracket-order error", { message: e.message }, "error");
          }
        });

      // Templates
      document
        .getElementById("saveTplBtn")
        .addEventListener("click", async () => {
          try {
            const name = (
              document.getElementById("tplName").value || ""
            ).trim();
            const payload = {
              name,
              symbol: (document.getElementById("brSymbol").value || "").trim(),
              side: document.getElementById("brSide").value,
              type: document.getElementById("brType").value,
              amount: (document.getElementById("brAmount").value || "").trim(),
              price: (
                document.getElementById("brEntryPrice").value || ""
              ).trim(),
              sl_price: (document.getElementById("brSl").value || "").trim(),
              tp_price: (document.getElementById("brTp").value || "").trim(),
            };
            const resp = await restFetch("/api/v2/order/templates", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            logSection("Template saved", resp, "success");
          } catch (e) {
            logSection("Save template error", { message: e.message }, "error");
          }
        });
      document
        .getElementById("listTplBtn")
        .addEventListener("click", async () => {
          try {
            const arr = await restFetch("/api/v2/order/templates");
            logSection("Templates", arr, "success");
          } catch (e) {
            logSection("List templates error", { message: e.message }, "error");
          }
        });

      // Backtest
      document
        .getElementById("runBtBtn")
        .addEventListener("click", async () => {
          try {
            const symbol = (
              document.getElementById("btSymbol").value || ""
            ).trim();
            const timeframe = (
              document.getElementById("btTf").value || "1m"
            ).trim();
            const limit = parseInt(
              document.getElementById("btLimit").value || "500",
              10
            );
            const resp = await restFetch("/api/v2/strategy/backtest", {
              method: "POST",
              body: JSON.stringify({ symbol, timeframe, limit }),
            });
            logSection("Backtest", resp, "success");
          } catch (e) {
            logSection("Backtest error", { message: e.message }, "error");
          }
        });

      // Watchlist
      document
        .getElementById("watchlistBtn")
        .addEventListener("click", async () => {
          try {
            const arr = await restFetch(`/api/v2/market/watchlist`);
            logSection("Watchlist", arr);
          } catch (e) {
            logSection("Watchlist error", { message: e.message }, "error");
          }
        });

      // Performance
      document.getElementById("perfBtn").addEventListener("click", async () => {
        try {
          const data = await restFetch(`/api/v2/account/performance`);
          logSection("Performance", data, "success");
        } catch (e) {
          logSection("Performance error", { message: e.message }, "error");
        }
      });
      document
        .getElementById("perfDetailBtn")
        .addEventListener("click", async () => {
          try {
            const data = await restFetch(`/api/v2/account/performance/detail`);
            logSection("Performance detail", data, "success");
          } catch (e) {
            logSection(
              "Performance detail error",
              { message: e.message },
              "error"
            );
          }
        });

      // Risk UI
      document
        .getElementById("riskStatusBtn")
        .addEventListener("click", async () => {
          try {
            const resp = await restFetch("/api/v2/risk/status");
            logSection("Risk status", resp);
          } catch (e) {
            logSection("Risk status error", { message: e.message }, "error");
          }
        });

      document
        .getElementById("updateMaxTradesBtn")
        .addEventListener("click", async () => {
          try {
            const maxTrades = parseInt(
              document.getElementById("maxTradesInput").value || "10",
              10
            );
            const resp = await restFetch("/api/v2/risk/max-trades", {
              method: "POST",
              body: JSON.stringify({ max_trades_per_day: maxTrades }),
            });
            logSection("Max trades updated", resp, "success");
          } catch (e) {
            logSection(
              "Update max trades error",
              { message: e.message },
              "error"
            );
          }
        });

      document
        .getElementById("updatePauseBtn")
        .addEventListener("click", async () => {
          try {
            const paused =
              document.getElementById("pauseSelect").value === "true";
            const resp = await restFetch("/api/v2/risk/windows", {
              method: "POST",
              body: JSON.stringify({ paused }),
            });
            logSection("Pause updated", resp, "success");
          } catch (e) {
            logSection("Pause update error", { message: e.message }, "error");
          }
        });

      document
        .getElementById("updateWindowsBtn")
        .addEventListener("click", async () => {
          try {
            const tz = document.getElementById("tzInput").value.trim();
            const parseWin = (s) =>
              s
                .split(",")
                .map((r) => r.trim())
                .filter(Boolean)
                .map((r) => {
                  const parts = r.split("-");
                  return [parts[0], parts[1]];
                });
            const payload = {
              timezone: tz,
              windows: {
                mon: parseWin(document.getElementById("winMon").value),
                tue: parseWin(document.getElementById("winTue").value),
                wed: parseWin(document.getElementById("winWed").value),
                thu: parseWin(document.getElementById("winThu").value),
                fri: parseWin(document.getElementById("winFri").value),
                sat: [],
                sun: [],
              },
            };
            const resp = await restFetch("/api/v2/risk/windows", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            logSection("Windows updated", resp, "success");
          } catch (e) {
            logSection("Windows update error", { message: e.message }, "error");
          }
        });

      // Strategy settings
      document
        .getElementById("getStrategySettingsBtn")
        .addEventListener("click", async () => {
          try {
            const settings = await restFetch("/api/v2/strategy/settings");
            logSection("Strategy settings", settings, "success");
            document.getElementById("emaWeight").value = settings.ema_weight;
            document.getElementById("rsiWeight").value = settings.rsi_weight;
            document.getElementById("atrWeight").value = settings.atr_weight;
          } catch (e) {
            logSection(
              "Strategy settings error",
              { message: e.message },
              "error"
            );
          }
        });
      document
        .getElementById("saveStrategySettingsBtn")
        .addEventListener("click", async () => {
          try {
            const ema_weight = parseFloat(
              document.getElementById("emaWeight").value
            );
            const rsi_weight = parseFloat(
              document.getElementById("rsiWeight").value
            );
            const atr_weight = parseFloat(
              document.getElementById("atrWeight").value
            );
            const resp = await restFetch("/api/v2/strategy/settings", {
              method: "POST",
              body: JSON.stringify({ ema_weight, rsi_weight, atr_weight }),
            });
            logSection("Strategy settings saved", resp, "success");
          } catch (e) {
            logSection(
              "Save strategy settings error",
              { message: e.message },
              "error"
            );
          }
        });

      // Position size & Health
      document
        .getElementById("calcSizeBtn")
        .addEventListener("click", async () => {
          try {
            const risk_percent = parseFloat(
              document.getElementById("riskPercent").value
            );
            const symbol = (
              document.getElementById("sizeSymbol").value || ""
            ).trim();
            const side = document.getElementById("sizeSide").value;
            const timeframe = document.getElementById("sizeTf").value || "1m";
            const atr_multiplier_sl = parseFloat(
              document.getElementById("slAtr").value || "1.5"
            );
            const atr_multiplier_tp = parseFloat(
              document.getElementById("tpAtr").value || "3"
            );
            const resp = await restFetch("/api/v2/risk/position-size", {
              method: "POST",
              body: JSON.stringify({
                risk_percent,
                symbol,
                side,
                timeframe,
                atr_multiplier_sl,
                atr_multiplier_tp,
              }),
            });
            logSection("Position size", resp, "success");
          } catch (e) {
            logSection("Position size error", { message: e.message }, "error");
          }
        });
      document
        .getElementById("healthBtn")
        .addEventListener("click", async () => {
          try {
            const resp = await restFetch("/api/v2/health");
            logSection("Health (REST)", resp);
            if (socket) {
              socket.emit("ping_health");
            }
          } catch (e) {
            logSection("Health error", { message: e.message }, "error");
          }
        });

      // Initiera logg
      log("WebSocket test page loaded.");
    </script>
  </body>
</html>
